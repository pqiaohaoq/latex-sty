\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{semver}[2026/1/13 v1.0 SemVer comparison macros]

\RequirePackage{expl3}
\RequirePackage{xparse}

\ExplSyntaxOn

\seq_new:N \l__semver_tmp_seq
\int_new:N \l__semver_major_a_int
\int_new:N \l__semver_minor_a_int
\int_new:N \l__semver_patch_a_int
\int_new:N \l__semver_major_b_int
\int_new:N \l__semver_minor_b_int
\int_new:N \l__semver_patch_b_int
\tl_new:N \l__semver_tmp_tl

\cs_new_protected:Npn \__semver_safe_set_int:Nn #1 #2
  {
    \tl_set:Nx \l__semver_tmp_tl { #2 }
    \tl_trim_spaces:N \l__semver_tmp_tl
    
    \tl_if_blank:VTF \l__semver_tmp_tl
      { \int_zero:N #1 }
      {
        \int_set:Nn #1 { \l__semver_tmp_tl }
      }
  }

% Helper to parse version string (assumes no 'v' prefix)
\cs_new_protected:Npn \__semver_parse_a:n #1
  {
    \tl_set:Nx \l__semver_tmp_tl { #1 }
    \seq_set_split:NnV \l__semver_tmp_seq { . } \l__semver_tmp_tl
    
    \__semver_safe_set_int:Nn \l__semver_major_a_int { \seq_item:Nn \l__semver_tmp_seq { 1 } }
    \__semver_safe_set_int:Nn \l__semver_minor_a_int { \seq_item:Nn \l__semver_tmp_seq { 2 } }
    \__semver_safe_set_int:Nn \l__semver_patch_a_int { \seq_item:Nn \l__semver_tmp_seq { 3 } }
  }

\cs_new_protected:Npn \__semver_parse_b:n #1
  {
    \tl_set:Nx \l__semver_tmp_tl { #1 }
    \seq_set_split:NnV \l__semver_tmp_seq { . } \l__semver_tmp_tl
    
    \__semver_safe_set_int:Nn \l__semver_major_b_int { \seq_item:Nn \l__semver_tmp_seq { 1 } }
    \__semver_safe_set_int:Nn \l__semver_minor_b_int { \seq_item:Nn \l__semver_tmp_seq { 2 } }
    \__semver_safe_set_int:Nn \l__semver_patch_b_int { \seq_item:Nn \l__semver_tmp_seq { 3 } }
  }

% -1: a < b, 0: a = b, 1: a > b
\int_new:N \l__semver_comp_result_int

\cs_new_protected:Npn \__semver_compare:nn #1 #2
  {
    \__semver_parse_a:n { #1 }
    \__semver_parse_b:n { #2 }
    \int_compare:nNnTF { \l__semver_major_a_int } > { \l__semver_major_b_int }
      { \int_set:Nn \l__semver_comp_result_int { 1 } }
      {
        \int_compare:nNnTF { \l__semver_major_a_int } < { \l__semver_major_b_int }
          { \int_set:Nn \l__semver_comp_result_int { -1 } }
          {
            % Major equal, check minor
            \int_compare:nNnTF { \l__semver_minor_a_int } > { \l__semver_minor_b_int }
              { \int_set:Nn \l__semver_comp_result_int { 1 } }
              {
                \int_compare:nNnTF { \l__semver_minor_a_int } < { \l__semver_minor_b_int }
                  { \int_set:Nn \l__semver_comp_result_int { -1 } }
                  {
                    % Minor equal, check patch
                    \int_compare:nNnTF { \l__semver_patch_a_int } > { \l__semver_patch_b_int }
                      { \int_set:Nn \l__semver_comp_result_int { 1 } }
                      {
                        \int_compare:nNnTF { \l__semver_patch_a_int } < { \l__semver_patch_b_int }
                          { \int_set:Nn \l__semver_comp_result_int { -1 } }
                          { \int_set:Nn \l__semver_comp_result_int { 0 } }
                      }
                  }
              }
          }
      }
  }

\prg_new_protected_conditional:Npnn \semver_if_eq:nn #1 #2 { T, F, TF }
  {
    \__semver_compare:nn { #1 } { #2 }
    \int_compare:nNnTF { \l__semver_comp_result_int } = { 0 }
      { \prg_return_true: }
      { \prg_return_false: }
  }

\prg_new_protected_conditional:Npnn \semver_if_ge:nn #1 #2 { T, F, TF }
  {
    \__semver_compare:nn { #1 } { #2 }
    \int_compare:nNnTF { \l__semver_comp_result_int } > { -1 }
      { \prg_return_true: }
      { \prg_return_false: }
  }

\prg_new_protected_conditional:Npnn \semver_if_le:nn #1 #2 { T, F, TF }
  {
    \__semver_compare:nn { #1 } { #2 }
    \int_compare:nNnTF { \l__semver_comp_result_int } < { 1 }
      { \prg_return_true: }
      { \prg_return_false: }
  }

\prg_new_protected_conditional:Npnn \semver_if_between:nnn #1 #2 #3 { T, F, TF }
  {
    % Check if #1 >= #2 AND #1 <= #3
    \semver_if_ge:nnTF { #1 } { #2 }
      {
        \semver_if_le:nnTF { #1 } { #3 }
          { \prg_return_true: }
          { \prg_return_false: }
      }
      { \prg_return_false: }
  }

\NewDocumentCommand{\semverEq}{ m m m m }
  {
    \semver_if_eq:nnTF { #1 } { #2 } { #3 } { #4 }
  }

\NewDocumentCommand{\semverGe}{ m m m m }
  {
    \semver_if_ge:nnTF { #1 } { #2 } { #3 } { #4 }
  }

\NewDocumentCommand{\semverLe}{ m m m m }
  {
    \semver_if_le:nnTF { #1 } { #2 } { #3 } { #4 }
  }

\NewDocumentCommand{\semverBetween}{ m m m m m }
  {
    \semver_if_between:nnnTF { #1 } { #2 } { #3 } { #4 } { #5 }
  }

\ExplSyntaxOff
